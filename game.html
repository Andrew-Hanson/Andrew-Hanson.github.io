<!DOCTYPE html>
<html>

<head>
    <title>Gamepage</title>
    <meta charset="UTF-8">
    <meta lang="en">
    <style>
        #start-menu {
            width: 90%;
            max-width: 500px;
            background-color: #4CAF50;
            color: white;
            margin: 40px auto;
            padding: 30px;
            border: 10px solid #4CAF50;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .box {
            width: 66%;
            right: 17%;
            height: 200px;
            border: 2px solid #000200;
            background-color: #787e78;
            padding: 10px;
            alignment-baseline: central;
        }

        #dealer {
            position: fixed;
            top: 1rem;
        }

        #player {
            position: fixed;
            bottom: 1rem;
        }

        #actions {
            width: 30px;
            bottom: 0;
            right: 10%;
            position: fixed;
        }

        button {
            background-color: white;
            border-radius: 18px;
            border: 10px solid #4CAF50;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }

        .card {
            border: solid 2px #000000;
            border-radius: 9px;
            width: 95px;
            height: 150px;
            float: left;
            background-color: white;
            padding: 3px 3px 3px 3px;
            margin: 5px;
        }

        /*
        .card {
            border: 1px solid #000000;
            background-color: rgb(163, 163, 197);
            border-radius: 12px;
            padding: 14px;
            margin-top: 12px;
        }
        */
        .value {
            font-size: 15pt;
            font-weight: bold;
            font-family: sans-serif;
        }

        #startbet {}

        .hidden {
            display: none;
        }

        .centered {
            position: fixed;
            height: 25%;
            left: 40%;
            top: 50%;
        }

        #player-select {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin: 0 auto;
            max-width: 200px;
        }
    </style>
</head>

<body>
    <main>

        <div id="start-menu">
            <h1>Blackjack</h1>
            <div id="user-bar">
                <span id="uname">Player:</span>
            </div>
        </div>

        <div id="startbet" class="centered">
            <label for="startvalue">Initial Bet:</label>
            <input type="text" id="startvalue">
        </div>

        <div id="game" class="hidden">
            <div id="dealer" class="box"></div>
            <div id="player" class="box"></div>

            <div id="actions">
                <button id="hit">Hit</button>
                <button id="stand">Stand</button>
                <button id="double">Double Down</button>
            </div>

            <div id="bet">Bet: </div>
            <div id="uname-display">User:</div>

            <div id="restart" class="centered hidden">
                Play Another Game?
                <button onclick="restart()">Yes</button>
                <button>No</button>
            </div>
        </div>
    </main>
    <script>
        // const newHeading = document.createElement("h1");
        // newHeading.textContent = "Hello, World!";
        // const newParagraph = document.createElement("p");
        // newParagraph.textContent = "This is embedded HTML content" + playerObj.players.name;
        // Math.floor(Math.random() * 4);
        // Experience + Rounds Played
    
        const STORAGE_KEYS = {
            currentUser: 'game.currentUser'
        };
        const rawUser = localStorage.getItem(STORAGE_KEYS.currentUser);

        if (!rawUser) {
            // No logged-in user – send them back to login page
            window.location.href = "index.html";
        } else {
            currentUser = JSON.parse(rawUser);
        }

        const unameHeader = document.getElementById("uname");
        const unameInGame = document.getElementById("uname-display");
        const cardsuits = '["spades", "diamonds", "hearts", "clubs"]';
        const cardvalues = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

        let starting_cash = 100000;
        let starting = 0;
        let dealerscore = 0;
        let playerscore = 0;

        // Buttons shared across handlers
        let hit, stand, dd;

        function enableFeature(buttonId, sectionId) {
            const button = document.getElementById(buttonId);
            const section = document.getElementById(sectionId);

            button.addEventListener('click', () => {
                section.classList.remove('hidden');
            }, { once: true });
        }

        function endRound(message) {
            alert(message);
            document.getElementById("restart").classList.remove("hidden");

            // Disable buttons so they don't stack
            hit.removeEventListener("click", hitHandler);
            dd.removeEventListener("click", doubleHandler);
            stand.removeEventListener("click", standHandler);
        }

        function computeHandValue(containerId) {
            const cards = document.getElementById(containerId).querySelectorAll(".value");
            let total = 0;
            let aces = 0;

            cards.forEach(card => {
                let v = card.innerText;

                if (v === "A") {
                    total += 11;
                    aces++;
                } else if (["J", "Q", "K"].includes(v)) {
                    total += 10;
                } else {
                    total += parseInt(v, 10);
                }
            });

            // Reduce Ace from 11 → 1 if over 21
            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }
            return total;
        }

        function addCard(person) {
            let number = Math.floor(Math.random() * 13);

            let card = document.createElement("div");
            let value = document.createElement("span");

            card.classList.add("card");
            value.classList.add("value");

            value.innerText = cardvalues[number];
            let num_value = value.innerText;

            switch (num_value) {
                case "A":
                    num_value = 1;
                    break;
                case "J":
                    num_value = 11;
                    break;
                case "Q":
                    num_value = 12;
                    break;
                case "K":
                    num_value = 13;
                    break;
                default:
                    num_value = parseInt(num_value, 10);
            }

            card.appendChild(value);
            document.getElementById(person).appendChild(card);
            return num_value;
        }

        function hitHandler() {
            addCard("player");

            playerscore = computeHandValue("player");
            if (playerscore > 21) {
                endRound("BUST! You went over 21.");
            }
        }

        function doubleHandler() {
            playerscore += addCard("player");
            starting = starting * 2;
            document.getElementById("bet").innerText = "Bet: " + starting;
        }

        function standHandler() {
            playerscore = computeHandValue("player");
            dealerscore = computeHandValue("dealer");

            // Dealer keeps hitting while behind the player and not busted
            while (dealerscore < playerscore && dealerscore <= 21) {
                addCard("dealer");
                dealerscore = computeHandValue("dealer");
            }
            let message;

            if (dealerscore > 21) {
                message = `Dealer busts with ${dealerscore}. You win!`;
            } else if (dealerscore > playerscore) {
                message = `Dealer wins ${dealerscore} vs ${playerscore}.`;
            } else if (dealerscore === playerscore) {
                message = `Push: both have ${playerscore}.`;
            } else {
                message = `You win ${playerscore} vs ${dealerscore}.`;
            }

            endRound(message);
        }

        function restart() {
            document.getElementById("player").innerText = "";
            document.getElementById("dealer").innerText = "";

            document.getElementById("restart").classList.add("hidden");
            document.getElementById("game").classList.add("hidden");

            // Show bet screen again; next round will start after next bet
            document.getElementById("startbet").classList.remove("hidden");
            // clear previous bet
            document.getElementById("startvalue").value = "";
            betInput.focus();
        }

        function gameRun() {
            // Reset scores for this round
            dealerscore = 0;
            playerscore = 0;

            dealerscore += addCard("dealer");
            dealerscore += addCard("dealer");

            playerscore += addCard("player");
            playerscore += addCard("player");

            // Initialize global button refs
            hit = document.getElementById('hit');
            stand = document.getElementById('stand');
            dd = document.getElementById("double");

            hit.addEventListener("click", hitHandler);
            dd.addEventListener("click", doubleHandler);
            stand.addEventListener("click", standHandler);
        }

        if (currentUser) {
            unameHeader.textContent = `Player: ${currentUser.username}`;
            unameInGame.textContent = `User: ${currentUser.username}`;
        }

        const betInput = document.getElementById("startvalue");
        betInput.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                // Get the input as integer
                let valueInt = parseInt(event.target.value, 10);

                if (isNaN(valueInt) || valueInt <= 0) {
                    alert("Please enter a valid positive number for your bet.");
                    return;
                }

                // Save it
                starting = valueInt;
                document.getElementById("bet").innerText = "Bet: " + starting;

                // Hide bet screen, show game, start round
                document.getElementById("startbet").classList.add("hidden");
                document.getElementById("game").classList.remove("hidden");
                gameRun();
            }
        });
    </script>
</body>
</html>