<!DOCTYPE html>
<html>
<head>
    <title>Gamepage</title>
    <meta charset="UTF-8">
    <meta lang="en">
    <style>
        #start-menu {
            width: 90%;
            max-width: 500px;
            background-color: #4CAF50;
            color: white;
            margin: 40px auto;
            padding: 30px;
            border: 10px solid #4CAF50;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        .box {
            width: 66%;
            right: 17%;
            height: 200px;
            border: 2px solid #000200;
            background-color: #787e78;
            padding: 10px;
            alignment-baseline: central;
        }
        #dealer {
            position: fixed;
            top: 1rem;
        }
        #player {
            position: fixed;
            bottom: 1rem;
        }
        #actions {
            width: 30px;
            bottom: 0;
            right: 10%;
            position: fixed;
        }
        button {
            background-color: white;
            border-radius: 18px;
            border: 10px solid #4CAF50;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }
        .card {
            border: solid 2px #000000;
            border-radius: 9px;
            width: 95px;
            height: 150px;
            float: left;
            background-color: white;
            padding: 3px 3px 3px 3px;
            margin: 5px;
        }
        .value {
            font-size: 15pt;
            font-weight: bold;
            font-family: sans-serif;
        }
        .hidden {
            display: none;
        }
        .centered {
            position: fixed;
            height: 25%;
            left: 40%;
            top: 50%;
        }
    </style>
</head>
<body>
    <main>
        <div id="start-menu">
            <h1>Blackjack</h1>
            <div id="user-bar">
                <span id="uname">Player:</span>
            </div>
        </div>

        <div id="startbet" class="centered">
            <label for="startvalue">Initial Bet:</label>
            <input type="text" id="startvalue">
        </div>

        <div id="game" class="hidden">
            <div id="dealer" class="box"></div>
            <div id="player" class="box"></div>

            <div id="actions">
                <button id="hit">Hit</button>
                <button id="stand">Stand</button>
                <button id="double">Double Down</button>
            </div>

            <div id="bet">Bet: </div>
            <div id="uname-display">Player:</div>
            <div id="balance">Balance: </div>

            <div id="restart" class="centered hidden">
                Play Another Game?
                <button onclick="restart()">Yes</button>
                <button>No</button>
            </div>
        </div>
    </main>
	<script>
        const STORAGE_KEYS = {
            currentUser: 'game.currentUser'
        };
        const rawUser = localStorage.getItem(STORAGE_KEYS.currentUser);
    	let currentUser = null;
        
        if (!rawUser) {
            // No logged in user, send back to login page
            window.location.href = "index.html";
        } else {
            currentUser = JSON.parse(rawUser);
        }

        const unameHeader = document.getElementById("uname");
        const unameInGame = document.getElementById("uname-display");

        const cardsuits = ["clubs", "diamonds", "hearts", "spades"];
        const cardvalues = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

        let deck = [];
        let dealerCards = [];
        let playerCards = [];
        let hiddenDealerCard = null;   // DOM element of facedown card

        let starting = 0;
        let dealerscore = 0;
        let playerscore = 0;
        let balance = 100000;

        // Buttons shared across handlers
        let hit, stand, dd;

        function loadCurrentUser() {
            const raw = localStorage.getItem(STORAGE_KEYS.currentUser);
            if (!raw) return;
			
            currentUser = JSON.parse(raw);
			
            if (currentUser.balance && currentUser.balance > 0) {
                balance = currentUser.balance;
            } else {
                // if no balance, initialize
                currentUser.balance = balance;
            }
			
            unameHeader.innerText = `Player: ${currentUser.username}`;
            unameInGame.innerText = `Player: ${currentUser.username}`;
			
            updateBalance();
		}

        function updateBalance() {
            const bal = document.getElementById("balance");
            if (bal) {
                bal.innerText = `Balance: ${balance}`;
        	}
            currentUser.balance = balance;
            localStorage.setItem(STORAGE_KEYS.currentUser, JSON.stringify(currentUser));
        }

        function buildDeck() {
            deck = [];
            for (const suit of cardsuits) {
                for (const rank of cardvalues) {
                    let value;
                    if (rank === "A") value = 11;
                    else if (["J", "Q", "K"].includes(rank)) value = 10;
                    else value = parseInt(rank, 10);
					
                	deck.push({ suit, rank, value });
                }
            }
        }

        function drawCard() {
            if (deck.length === 0) buildDeck();
            const idx = Math.floor(Math.random() * deck.length);
            const [card] = deck.splice(idx, 1);
            return card;
        }

        function renderCard(cardObj, containerId, faceDown = false) {
            const card = document.createElement("div");
            card.classList.add("card");
			
            const img = document.createElement("img");
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "contain";
			
            if (faceDown) {
                img.src = "cards/back_of_card.png";
                card.dataset.faceDown = "true";
            } else {
                img.src = `cards/${cardObj.rank.toLowerCase()}_of_${cardObj.suit}.png`;
            }
			
            card.appendChild(img);
            document.getElementById(containerId).appendChild(card);
			
            return card;
    	}

        function computeHandValue(cards) {
            let total = 0;
            let aces = 0;
			
            for (const c of cards) {
                total += c.value;
                if (c.rank === "A") aces++;
            }
			
            // downgrade Aces from 11 â†’ 1 while busting
            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }
            return total;
        }

        function addCard(person, show = true) {
        	const c = drawCard();
            
            if (person === "player") {
            	playerCards.push(c);
            	renderCard(c, person);
            } else if (show) {
            	dealerCards.push(c);
            	renderCard(c, "dealer");
     	   } else {
           		dealerCards.push(c);
            	hiddenDealerCard = renderCard(c, "dealer", true);
           }
  	  }

        function revealDealerHiddenCard() {
        	let hasHiddenDealerCard = hiddenDealerCard !== null;
            if (!hasHiddenDealerCard || !hiddenDealerCard) return;
			
            const card = dealerCards[0];
            const img = hiddenDealerCard.querySelector("img");
            if (img) {
                img.src = `cards/${card.rank.toLowerCase()}_of_${card.suit}.png`;
 	       }
    	}

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function endRound(message) {
            alert(message);
            document.getElementById("restart").classList.remove("hidden");
		
            // Disable buttons so they don't stack
            hit.removeEventListener("click", hitHandler);
            dd.removeEventListener("click", doubleHandler);
            stand.removeEventListener("click", standHandler);
  		}

    	async function hitHandler() {
        	addCard("player");
			
            playerscore = computeHandValue(playerCards);
            if (playerscore > 21) {
                balance -= starting;
                updateBalance();
                await sleep(500);
		
            	endRound(`BUST! You went over 21 with ${playerscore}.`);
        	}
   		}
        
        function doubleHandler() {
            starting = starting * 2;
            hitHandler();
		}

        async function standHandler() {
            revealDealerHiddenCard();
            await sleep(500);
			
            playerscore = computeHandValue(playerCards);
            dealerscore = computeHandValue(dealerCards);
			
        	// Dealer keeps hitting while behind the player and not busted
        	while (dealerscore < playerscore && dealerscore <= 21) {
            	addCard("dealer");
                dealerscore = computeHandValue(dealerCards);
                await sleep(500);
            }
			
            let message;
			
            if (dealerscore > 21) {
                message = `Dealer busts with ${dealerscore}. You win!`;
                balance += starting;
            } else if (dealerscore > playerscore) {
                message = `Dealer wins ${dealerscore} vs ${playerscore}.`;
                balance -= starting;
            } else if (dealerscore === playerscore) {
                message = `Push: both have ${playerscore}.`;
            } else {
                message = `You win ${playerscore} vs ${dealerscore}.`;
                balance += starting;
            }
			
            updateBalance();
            await sleep(500);
            endRound(message);
		}

		function restart() {
            document.getElementById("player").innerHTML = "";
            document.getElementById("dealer").innerHTML = "";
			
            document.getElementById("restart").classList.add("hidden");
            document.getElementById("game").classList.add("hidden");
			
            // Show bet screen again; next round will start after next bet
            document.getElementById("startbet").classList.remove("hidden");
            document.getElementById("startvalue").value = "";
            betInput.focus();
		}

    // make restart available to inline onclick
    window.restart = restart;

        function gameRun() {
            // Clear previous cards
            document.getElementById("dealer").innerHTML = "";
            document.getElementById("player").innerHTML = "";        
			
            dealerCards = [];
            playerCards = [];
            hiddenDealerCard = null;
            
            buildDeck();
			
            // Reset scores for this round
            dealerscore = 0;
            playerscore = 0;
			
            // --- initial deal:
            // Dealer: 1st card facedown
            addCard("dealer", false);
			
            // Dealer: 2nd card
            addCard("dealer");
			
            // Player: two cards
            addCard("player");
            addCard("player");
			
			playerscore = computeHandValue(playerCards);
        	dealerscore = computeHandValue(dealerCards);
			
            // Initialize global button refs
            hit = document.getElementById('hit');
            stand = document.getElementById('stand');
            dd = document.getElementById("double");
			
            hit.addEventListener("click", hitHandler);
            dd.addEventListener("click", doubleHandler);
            stand.addEventListener("click", standHandler);
        }

		loadCurrentUser();

        const betInput = document.getElementById("startvalue");
        betInput.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                // Get the input as integer
                let valueInt = parseInt(event.target.value, 10);
				
                if (isNaN(valueInt) || valueInt <= 0) {
                    alert("Please enter a valid positive number for your bet.");
                    return;
                }
				
                // Save it
                starting = valueInt;
                document.getElementById("bet").innerText = "Bet: " + starting;
				
                if (valueInt > balance) {
                    alert("You cannot bet more than your current balance.");
                    return;
                }
				
                starting = valueInt;
                document.getElementById("bet").innerText = "Bet: " + starting;
				
                document.getElementById("startbet").classList.add("hidden");
                document.getElementById("game").classList.remove("hidden");
                gameRun();
            }
        });
    </script>
</body>
</html>